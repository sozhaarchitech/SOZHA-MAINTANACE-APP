<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details | SOZHA</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <style>
        .reveal-anim {
            animation: revealDesign 1.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes revealDesign {
            0% {
                clip-path: circle(0% at 50% 50%);
                filter: brightness(0);
            }

            100% {
                clip-path: circle(150% at 50% 50%);
                filter: brightness(1);
            }
        }

        .refresh-btn {
            background: var(--success);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .refresh-btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .refresh-btn .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .design-gallery {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            scroll-snap-type: x mandatory;
        }

        .gallery-item {
            flex: 0 0 calc(100% - 2rem);
            height: 350px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            border: 2px solid var(--accent-color);
            scroll-snap-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .gallery-item:hover {
            transform: scale(0.98);
        }

        .video-container {
            margin-top: 2rem;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 16/9;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>

<body class="client-view">
    <div class="liquid-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
        <div class="blob blob-4"></div>
    </div>
    <div class="container" style="max-width: 600px; padding-top: 4rem;">
        <div style="text-align: center; margin-bottom: 2rem;">
            <div class="logo" style="font-size: 2rem;">SOZHA</div>
            <p style="color: var(--accent-color); letter-spacing: 2px;">MAINTENANCE REPORT</p>
        </div>

        <div id="clientContent" class="card">
            <div id="loading" style="text-align: center; padding: 2rem;">
                <p>Fetching project data...</p>
            </div>

            <div id="projectData" style="display: none;">
                <h1 id="cProjName" style="margin-bottom: 0.5rem;">Project Name</h1>
                <div id="cStatusBadge" class="status-badge" style="display: inline-block; margin-bottom: 2rem;">Active
                </div>
                <div style="float: right; margin-top: -10px; display: flex; gap: 0.5rem;">
                    <a href="brochure.html" class="secondary"
                        style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.8rem;" target="_blank">
                        <span class="iconify" data-icon="material-symbols:book-2-outline"></span>
                        Brochure
                    </a>
                </div>

                <div class="form-group">
                    <label>Client</label>
                    <p id="cClientName" style="font-weight: 600;">Client Name</p>
                </div>

                <div class="form-group">
                    <label>Last Updated</label>
                    <p id="cLastUpdate">20 Jan 2026</p>
                </div>

                <div class="stat-row">
                    <span class="stat-label">Current Stage</span>
                    <span id="cStage" class="stat-value">Planning</span>
                </div>

                <div class="progress-container">
                    <div id="cProgressBar" class="progress-bar"></div>
                </div>

                <div class="financial-grid">
                    <div>
                        <div class="stat-label">Total Amount</div>
                        <div id="cTotalCost" class="stat-value">â‚¹0</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="stat-label">Paid Amount</div>
                        <div id="cPaidAmount" class="stat-value" style="color: #4CAF50;">â‚¹0</div>
                    </div>
                </div>

                <div class="stat-row"
                    style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dotted var(--border-color);">
                    <span class="stat-label">Balance Remaining</span>
                    <span id="cBalance" class="stat-value" style="color: #ff4444; font-size: 1.1rem;">â‚¹0</span>
                </div>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label>Maintenance Notes</label>
                    <p id="cNotes" style="color: var(--text-secondary);"></p>
                </div>

                <!-- Design Unlock Section -->
                <div id="designSection"
                    style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">Project Design</h3>

                    <div id="lockedDesign" style="position: relative; text-align: center;">
                        <div id="designBlur"
                            style="filter: blur(15px); pointer-events: none; height: 300px; background: #333; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <span class="iconify" data-icon="material-symbols:image-outline"
                                style="font-size: 5rem; color: #444;"></span>
                        </div>

                        <div id="paymentOverlay"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); border-radius: 12px; padding: 1.5rem;">
                            <span class="iconify" data-icon="material-symbols:lock-outline"
                                style="font-size: 3rem; color: var(--accent-color); margin-bottom: 1rem;"></span>
                            <h4 style="color: white; margin-bottom: 0.5rem;">Design Locked</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 1.5rem; color: #eee;">Clear the balance to
                                unlock high-quality designs.</p>

                            <div id="upiQR"
                                style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 1rem;">
                                <!-- UPI QR will be injected here -->
                            </div>

                            <a id="upiLink" href="#" class="btn"
                                style="background: var(--accent-color); color: black; text-decoration: none; padding: 0.8rem 1.5rem; border-radius: 6px; font-weight: 700;">PAY
                                VIA UPI</a>

                            <button id="refreshPaymentBtn" class="refresh-btn" onclick="fetchProject()">
                                <span class="iconify" data-icon="material-symbols:refresh"></span>
                                Check Payment Status
                            </button>
                        </div>
                    </div>

                    <div id="unlockedDesign" style="display: none;">
                        <h4 style="margin-bottom: 1rem; color: var(--accent-color);">Design Gallery</h4>
                        <div id="designGallery" class="design-gallery">
                            <!-- Images will be injected here -->
                        </div>

                        <div id="videoSection" style="display: none; margin-top: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--accent-color);">Project Walkthrough Video</h4>
                            <div class="video-container" id="videoContainer">
                                <!-- Video player will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="error" style="display: none; text-align: center; color: var(--error);">
                <p>Project not found or invalid QR code.</p>
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <p style="font-size: 0.8rem; color: var(--text-secondary);">Â© 2026 SOZHA DESIGN & BUILD</p>
        </div>
    </div>


    <script>
        // Simple client-side fetching logic
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('id');

        async function fetchProject() {
            if (!projectId) {
                showError();
                return;
            }
            try {
                const defaultScriptUrl = 'https://script.google.com/macros/s/AKfycbxlYXUZZyy_Rqh2pmp5VI10HqHu02Ty2Nd7zhRz3cpf4wwwDksq-tzP70YMN1nx97oW/exec';
                const scriptUrl = localStorage.getItem('sozha_script_url') || defaultScriptUrl;

                const response = await fetch(`${scriptUrl}?action=getProject&id=${projectId}`);
                const data = await response.json();

                if (data.status === 'success') {
                    displayProject(data.data);
                } else {
                    showError();
                }
            } catch (e) {
                showError();
            }
        }

        function displayProject(proj) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('projectData').style.display = 'block';

            document.getElementById('cProjName').textContent = proj.name;
            document.getElementById('cClientName').textContent = proj.client;
            document.getElementById('cStage').textContent = proj.currentStage || "Ongoing";
            document.getElementById('cTotalCost').textContent = `â‚¹${(proj.totalCost || 0).toLocaleString()}`;
            document.getElementById('cPaidAmount').textContent = `â‚¹${(proj.paidAmount || 0).toLocaleString()}`;

            const balance = (proj.totalCost || 0) - (proj.paidAmount || 0);
            document.getElementById('cBalance').textContent = `â‚¹${balance.toLocaleString()}`;
            document.getElementById('cBalance').style.color = balance > 0 ? '#ff4444' : '#4CAF50';

            const progress = (proj.paidAmount / proj.totalCost * 100) || 0;
            document.getElementById('cProgressBar').style.width = `${progress}%`;

            document.getElementById('cStatusBadge').textContent = `${proj.type} - ${proj.status}`;
            document.getElementById('cStatusBadge').className = `status-badge status-${proj.status.toLowerCase()}`;
            document.getElementById('cNotes').textContent = proj.notes || "No recent updates.";
            document.getElementById('cLastUpdate').textContent = proj.lastUpdate || "Recently";

            // Handle Design Section
            if (proj.designUrl || proj.videoUrl) {
                document.getElementById('designSection').style.display = 'block';
                if (balance > 0) {
                    document.getElementById('lockedDesign').style.display = 'block';
                    document.getElementById('unlockedDesign').style.display = 'none';
                    if (proj.designUrl) {
                        const firstImg = proj.designUrl.split(',')[0].trim();
                        document.getElementById('designBlur').style.backgroundImage = `url('${firstImg}')`;
                        document.getElementById('designBlur').style.backgroundSize = 'cover';
                    }
                    generateUPI(proj, balance);
                } else {
                    const unlockedEl = document.getElementById('unlockedDesign');
                    const wasLocked = document.getElementById('lockedDesign').style.display !== 'none';

                    document.getElementById('lockedDesign').style.display = 'none';
                    unlockedEl.style.display = 'block';

                    // Render Image Gallery
                    const gallery = document.getElementById('designGallery');
                    gallery.innerHTML = '';
                    if (proj.designUrl) {
                        const images = proj.designUrl.split(',').map(url => url.trim());
                        images.forEach(img => {
                            const item = document.createElement('div');
                            item.className = 'gallery-item';
                            item.style.backgroundImage = `url('${img}')`;
                            item.onclick = () => window.open(img, '_blank');
                            gallery.appendChild(item);
                        });
                    }

                    // Render Video if exists
                    const videoSec = document.getElementById('videoSection');
                    const videoCont = document.getElementById('videoContainer');
                    if (proj.videoUrl) {
                        videoSec.style.display = 'block';
                        videoCont.innerHTML = renderVideoPlayer(proj.videoUrl);
                    } else {
                        videoSec.style.display = 'none';
                    }

                    if (wasLocked) {
                        unlockedEl.classList.add('reveal-anim');
                        showNotification('Design Unlocked! ðŸŽ‰');
                    }
                }
            }
        }

        function renderVideoPlayer(url) {
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let id = '';
                if (url.includes('v=')) id = url.split('v=')[1].split('&')[0];
                else id = url.split('/').pop();
                return `<iframe src="https://www.youtube.com/embed/${id}" allowfullscreen></iframe>`;
            } else {
                return `<video controls style="width:100%; height:100%;"><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video>`;
            }
        }

        function showNotification(msg) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                left: 50%;
                transform: translateX(-50%);
                padding: 1rem 2rem;
                background: var(--success);
                color: white;
                border-radius: 50px;
                font-weight: 700;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                z-index: 9999;
                animation: toastSlide 0.5s ease forwards;
            `;
            toast.textContent = msg;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        // Add CSS for toast
        const style = document.createElement('style');
        style.textContent = `
            @keyframes toastSlide {
                from { top: -50px; opacity: 0; }
                to { top: 2rem; opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        function generateUPI(proj, balance) {
            const upiId = "sozhaarchitect@okaxis"; // You can make this dynamic later
            const name = "SOZHA ARCHITECTS";
            const amount = balance;
            const note = `Payment for ${proj.name}`;

            const upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(name)}&am=${amount}&tn=${encodeURIComponent(note)}&cu=INR`;

            // Generate QR using externally provided API (since qrcode.js isn't here)
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiUrl)}`;
            document.getElementById('upiQR').innerHTML = `<img src="${qrApiUrl}" alt="UPI QR">`;
            document.getElementById('upiLink').href = upiUrl;
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            if (msg) document.querySelector('#error p').textContent = msg;
        }

        if (projectId) fetchProject();

    </script>
</body>

</html>